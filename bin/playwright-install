#!/usr/bin/env php
<?php

/**
 * Playwright Server Installer
 * Installs Node.js dependencies for the Playwright server using Symfony Process
 */

$possibleFiles = [
    __DIR__.'/../../../autoload.php',
    __DIR__.'/../../autoload.php',
    __DIR__.'/../../vendor/autoload.php',
    __DIR__.'/../vendor/autoload.php',
    __DIR__.'/vendor/autoload.php',
];
$file = null;

foreach ($possibleFiles as $possibleFile) {
    if (file_exists($possibleFile)) {
        $file = $possibleFile;

        break;
    }
}

if (null === $file) {
    throw new RuntimeException('Unable to locate autoload.php file.');
}

require_once $file;

use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Process\Exception\ProcessFailedException;
use Symfony\Component\Process\Process;

final class PlaywrightServerInstaller
{
    private const MIN_NODE_VERSION = '20.0.0';

    private string $serverDir;

    private OutputInterface $output;

    private bool $verbose;

    private bool $dryRun;

    private bool $shouldInstallBrowsers;

    private bool $withDeps;

    /**
     * Cache of command availability checks.
     *
     * @var array<string, bool>
     */
    private array $commandAvailability = [];

    public function __construct(bool $verbose, bool $dryRun, bool $installBrowsers, bool $withDeps)
    {
        $this->serverDir = __DIR__;
        $this->output = new ConsoleOutput();
        $this->verbose = $verbose;
        $this->dryRun = $dryRun;
        $this->shouldInstallBrowsers = $installBrowsers;
        $this->withDeps = $withDeps;

        if ($this->verbose) {
            $this->output->setVerbosity(OutputInterface::VERBOSITY_VERBOSE);
        }
    }

    public function install(): int
    {
        $this->output->writeln('<info>Installing Playwright Server...</info>');

        if ($this->dryRun) {
            $this->output->writeln('<comment>Dry run mode enabled. Installation commands will not be executed.</comment>');
        }

        try {
            $this->checkRequirements();
            $this->ensureServerDirectory();
            $this->installNodeDependencies();

            if ($this->dryRun) {
                $this->output->writeln('[dry-run] Skipping verification step.');
            } else {
                $this->verifyInstallation();
            }

            if ($this->shouldInstallBrowsers) {
                $this->installBrowserBinaries();
            }

            $this->output->writeln('✅ <info>Playwright Server installed successfully!</info>');

            return 0;
        } catch (Exception $e) {
            $this->output->writeln("❌ <error>Installation failed: {$e->getMessage()}</error>");

            if ($this->verbose && $e instanceof ProcessFailedException) {
                $this->output->writeln('<error>Process stderr:</error>');
                $this->output->writeln($e->getProcess()->getErrorOutput());
            }

            return 1;
        }
    }

    private function checkRequirements(): void
    {
        $this->output->writeln('Checking requirements...', OutputInterface::VERBOSITY_VERBOSE);

        try {
            $nodeProcess = $this->runCommand(['node', '--version']);
        } catch (ProcessFailedException $exception) {
            throw new \RuntimeException('Node.js is required but not found in PATH.', 0, $exception);
        }

        $nodeVersion = trim($nodeProcess->getOutput());
        $version = str_replace('v', '', $nodeVersion);

        if (version_compare($version, self::MIN_NODE_VERSION, '<')) {
            throw new \RuntimeException(sprintf('Node.js %s+ is required, found version %s. Please upgrade Node.js.', self::MIN_NODE_VERSION, $nodeVersion));
        }

        $this->output->writeln("✓ Node.js $nodeVersion found");

        try {
            $npmProcess = $this->runCommand(['npm', '--version']);
        } catch (ProcessFailedException $exception) {
            throw new \RuntimeException('npm is required but not found in PATH.', 0, $exception);
        }

        $npmVersion = trim($npmProcess->getOutput());
        $this->output->writeln("✓ npm $npmVersion found");

        $this->checkPackageManager();
    }

    private function checkPackageManager(): void
    {
        if ($this->isCommandAvailable('pnpm')) {
            $this->output->writeln('✓ pnpm detected - using for faster installs', OutputInterface::VERBOSITY_VERBOSE);

            return;
        }

        if ($this->isCommandAvailable('yarn')) {
            $this->output->writeln('✓ yarn detected', OutputInterface::VERBOSITY_VERBOSE);

            return;
        }

        $this->output->writeln('✓ Using npm for package installation', OutputInterface::VERBOSITY_VERBOSE);
    }

    private function ensureServerDirectory(): void
    {
        if (!is_dir($this->serverDir)) {
            throw new \RuntimeException("Server directory not found: {$this->serverDir}");
        }

        if (!is_file($this->serverDir.'/package.json')) {
            throw new \RuntimeException('package.json not found in server directory');
        }

        $this->output->writeln('✓ Server directory found');
    }

    private function installNodeDependencies(): void
    {
        $this->output->writeln('Installing Node.js dependencies...');

        if ($this->isDependenciesUpToDate()) {
            $this->output->writeln('✓ Dependencies already up to date');

            return;
        }

        $packageManager = $this->detectPackageManager();
        $command = $this->getInstallCommand($packageManager);

        $this->output->writeln("Using $packageManager for installation", OutputInterface::VERBOSITY_VERBOSE);

        $this->runCommand($command, $this->serverDir, 300, true);

        $this->output->writeln('✓ Node.js dependencies installed');
    }

    private function isDependenciesUpToDate(): bool
    {
        $packageJsonPath = $this->serverDir.'/package.json';
        $nodeModulesPath = $this->serverDir.'/node_modules';

        if (!is_dir($nodeModulesPath)) {
            return false;
        }

        $lockFiles = [
                'package-lock.json',
                'yarn.lock',
                'pnpm-lock.yaml',
        ];

        $packageTime = filemtime($packageJsonPath);

        foreach ($lockFiles as $lockFile) {
            $lockPath = $this->serverDir.'/'.$lockFile;
            if (is_file($lockPath) && filemtime($lockPath) >= $packageTime) {
                return true;
            }
        }
        
        return false;
    }

    private function detectPackageManager(): string
    {
        $pnpmLock = is_file($this->serverDir.'/pnpm-lock.yaml');
        $yarnLock = is_file($this->serverDir.'/yarn.lock');

        $pnpmAvailable = $this->isCommandAvailable('pnpm');
        $yarnAvailable = $this->isCommandAvailable('yarn');

        if ($pnpmLock && $pnpmAvailable) {
            return 'pnpm';
        }

        if ($pnpmLock && !$pnpmAvailable) {
            $this->output->writeln('⚠️ pnpm-lock.yaml detected but pnpm is not available; falling back to npm');
        }

        if ($yarnLock && $yarnAvailable) {
            return 'yarn';
        }

        if ($yarnLock && !$yarnAvailable) {
            $this->output->writeln('⚠️ yarn.lock detected but yarn is not available; falling back to npm');
        }

        if ($pnpmAvailable) {
            return 'pnpm';
        }

        if ($yarnAvailable) {
            return 'yarn';
        }

        return 'npm';
    }

    private function getInstallCommand(string $packageManager): array
    {
        $hasPnpmLock = is_file($this->serverDir.'/pnpm-lock.yaml');
        $hasYarnLock = is_file($this->serverDir.'/yarn.lock');
        $hasNpmLock = is_file($this->serverDir.'/package-lock.json');

        return match ($packageManager) {
            'pnpm' => $hasPnpmLock
                    ? ['pnpm', 'install', '--prod', '--frozen-lockfile']
                    : ['pnpm', 'install', '--prod', '--no-frozen-lockfile'],
            'yarn' => $hasYarnLock
                    ? ['yarn', 'install', '--production', '--frozen-lockfile']
                    : ['yarn', 'install', '--production'],
            default => $hasNpmLock
                    ? ['npm', 'ci', '--only=production']
                    : ['npm', 'install', '--only=production']
        };
    }

    private function verifyInstallation(): void
    {
        $this->output->writeln('Verifying installation...', OutputInterface::VERBOSITY_VERBOSE);

        $this->runCommand(['node', '-p', "require.resolve('playwright')"], $this->serverDir, 30);

        if (!is_file($this->serverDir.'/playwright-server.js')) {
            throw new \RuntimeException('Server entry script not found: playwright-server.js');
        }

        $this->output->writeln('✓ Server verified');
    }

    private function installBrowserBinaries(): void
    {
        $this->output->writeln('Installing Playwright browsers...');

        $packageManager = $this->detectPackageManager();
        $command = $this->getBrowserInstallCommand($packageManager);

        $this->runCommand($command, $this->serverDir, null, true);

        $this->output->writeln('✓ Browsers installed');
    }

    private function getBrowserInstallCommand(string $packageManager): array
    {
        $args = ['install'];

        if ($this->withDeps) {
            $args[] = '--with-deps';
        }

        return match ($packageManager) {
            'pnpm' => array_merge(['pnpm', 'exec', 'playwright'], $args),
            'yarn' => array_merge(['yarn', 'playwright'], $args),
            default => array_merge(['npx', 'playwright'], $args),
        };
    }

    /**
     * @param array<int, string> $command
     */
    private function runCommand(array $command, ?string $cwd = null, ?int $timeout = 60, bool $allowDryRun = false): Process
    {
        $process = new Process($command, $cwd);
        $process->setTimeout($timeout);

        $this->output->writeln(sprintf('Running command: %s', $process->getCommandLine()), OutputInterface::VERBOSITY_VERBOSE);

        if ($allowDryRun && $this->dryRun) {
            $this->output->writeln(sprintf('[dry-run] Would execute: %s', $process->getCommandLine()));

            return $process;
        }

        $callback = $this->verbose
            ? function (string $type, string $buffer): void {
                $this->output->write($buffer);
            }
            : null;

        $process->run($callback);

        if (!$process->isSuccessful()) {
            throw new ProcessFailedException($process);
        }

        return $process;
    }

    private function isCommandAvailable(string $command): bool
    {
        if (array_key_exists($command, $this->commandAvailability)) {
            return $this->commandAvailability[$command];
        }

        $process = new Process([$command, '--version']);
        $process->run();

        return $this->commandAvailability[$command] = $process->isSuccessful();
    }
}

$argv = $_SERVER['argv'] ?? [];
$args = array_slice($argv, 1);

$verbose = false;
$dryRun = false;
$installBrowsers = false;
$withDeps = false;
$help = false;

foreach ($args as $arg) {
    switch ($arg) {
        case '-v':
        case '--verbose':
            $verbose = true;
            break;
        case '-h':
        case '--help':
            $help = true;
            break;
        case '--dry-run':
            $dryRun = true;
            break;
        case '--browsers':
            $installBrowsers = true;
            break;
        case '--with-deps':
            $installBrowsers = true;
            $withDeps = true;
            break;
        default:
            throw new \InvalidArgumentException(sprintf('Unknown option: %s', $arg));
    }
}

if ($help) {
    echo "Playwright Server Installer\n";
    echo "\n";
    echo "Usage: playwright-install [options]\n";
    echo "\n";
    echo "Options:\n";
    echo "  -v, --verbose     Show detailed output\n";
    echo "  -h, --help        Show this help message\n";
    echo "  --dry-run         Print commands without executing install steps\n";
    echo "  --browsers        Install Playwright browser binaries\n";
    echo "  --with-deps       Install browsers and system dependencies (implies --browsers)\n";
    echo "\n";
    echo "Requirements:\n";
    echo "  - Node.js 20+ (for optimal performance and security)\n";
    echo "  - npm, yarn, or pnpm\n";
    echo "\n";
    echo "This script automatically detects and uses the fastest available package manager.\n";
    echo "Preference order: pnpm > yarn > npm\n";
    exit(0);
}

$installer = new PlaywrightServerInstaller($verbose, $dryRun, $installBrowsers, $withDeps);
exit($installer->install());
