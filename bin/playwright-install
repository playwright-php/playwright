#!/usr/bin/env php
<?php

/**
 * Playwright Server Installer
 * Installs Node.js dependencies for the Playwright server using Symfony Process
 */

$possibleFiles = [__DIR__.'/../../../autoload.php', __DIR__.'/../../autoload.php', __DIR__.'/../vendor/autoload.php'];
$file = null;

foreach ($possibleFiles as $possibleFile) {
    if (file_exists($possibleFile)) {
        $file = $possibleFile;

        break;
    }
}

if (null === $file) {
    throw new RuntimeException('Unable to locate autoload.php file.');
}

require_once $file;

use Symfony\Component\Console\Output\ConsoleOutput;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Process\Process;
use Symfony\Component\Process\Exception\ProcessFailedException;

final class PlaywrightServerInstaller
{
    private string $serverDir;

    private OutputInterface $output;

    private bool $verbose;

    public function __construct()
    {
        $this->serverDir = __DIR__;
        $this->output = new ConsoleOutput();
        $this->verbose = \in_array('-v', $_SERVER['argv'] ?? [], true)
                || \in_array('--verbose', $_SERVER['argv'] ?? [], true);

        if ($this->verbose) {
            $this->output->setVerbosity(OutputInterface::VERBOSITY_VERBOSE);
        }
    }

    public function install(): int
    {
        $this->output->writeln('<info>Installing Playwright Server...</info>');

        try {
            $this->checkRequirements();
            $this->ensureServerDirectory();
            $this->installNodeDependencies();
            $this->verifyInstallation();

            $this->output->writeln('✅ <info>Playwright Server installed successfully!</info>');

            return 0;
        } catch (Exception $e) {
            $this->output->writeln("❌ <error>Installation failed: {$e->getMessage()}</error>");

            if ($this->verbose && $e instanceof ProcessFailedException) {
                $this->output->writeln('<error>Process output:</error>');
                $this->output->writeln('<error>'.$e->getProcess()->getOutput().'</error>');
                $this->output->writeln('<error>'.$e->getProcess()->getErrorOutput().'</error>');
            }

            return 1;
        }
    }

    private function checkRequirements(): void
    {
        $this->output->writeln('Checking requirements...', OutputInterface::VERBOSITY_VERBOSE);

        $nodeProcess = new Process(['node', '--version']);
        $nodeProcess->run();

        if (!$nodeProcess->isSuccessful()) {
            throw new \RuntimeException('Node.js is required but not found.');
        }

        $nodeVersion = trim($nodeProcess->getOutput());
        $version = str_replace('v', '', $nodeVersion);

        if (version_compare($version, '20.0.0', '<')) {
            throw new \RuntimeException(sprintf('Node.js 20+ is required, found version %s. Please upgrade Node.js.', $nodeVersion));
        }

        $this->output->writeln("✓ Node.js $nodeVersion found");

        $npmProcess = new Process(['npm', '--version']);
        $npmProcess->run();

        if (!$npmProcess->isSuccessful()) {
            throw new \RuntimeException('npm is required but not found.');
        }

        $npmVersion = trim($npmProcess->getOutput());
        $this->output->writeln("✓ npm $npmVersion found");

        $this->checkPackageManager();
    }

    private function checkPackageManager(): void
    {
        $pnpmProcess = new Process(['pnpm', '--version']);
        $pnpmProcess->run();

        if ($pnpmProcess->isSuccessful()) {
            $this->output->writeln('✓ pnpm detected - using for faster installs', OutputInterface::VERBOSITY_VERBOSE);

            return;
        }

        $yarnProcess = new Process(['yarn', '--version']);
        $yarnProcess->run();

        if ($yarnProcess->isSuccessful()) {
            $this->output->writeln('✓ yarn detected', OutputInterface::VERBOSITY_VERBOSE);

            return;
        }

        $this->output->writeln('✓ Using npm for package installation', OutputInterface::VERBOSITY_VERBOSE);
    }

    private function ensureServerDirectory(): void
    {
        if (!is_dir($this->serverDir)) {
            throw new \RuntimeException("Server directory not found: {$this->serverDir}");
        }

        if (!is_file($this->serverDir.'/package.json')) {
            throw new \RuntimeException('package.json not found in server directory');
        }

        $this->output->writeln('✓ Server directory found');
    }

    private function installNodeDependencies(): void
    {
        $this->output->writeln('Installing Node.js dependencies...');

        if ($this->isDependenciesUpToDate()) {
            $this->output->writeln('✓ Dependencies already up to date');

            return;
        }

        $packageManager = $this->detectPackageManager();
        $command = $this->getInstallCommand($packageManager);

        $this->output->writeln("Using $packageManager for installation", OutputInterface::VERBOSITY_VERBOSE);

        $process = new Process($command, $this->serverDir);
        $process->setTimeout(300);

        if ($this->verbose) {
            $process->run(function ($type, $buffer) {
                $this->output->write($buffer);
            });
        } else {
            $process->run();
        }

        if (!$process->isSuccessful()) {
            throw new ProcessFailedException($process);
        }

        $this->output->writeln('✓ Node.js dependencies installed');
    }

    private function isDependenciesUpToDate(): bool
    {
        $packageJsonPath = $this->serverDir.'/package.json';
        $nodeModulesPath = $this->serverDir.'/node_modules';

        if (!is_dir($nodeModulesPath)) {
            return false;
        }

        $lockFiles = [
                'package-lock.json',
                'yarn.lock',
                'pnpm-lock.yaml',
        ];

        $packageTime = filemtime($packageJsonPath);

        foreach ($lockFiles as $lockFile) {
            $lockPath = $this->serverDir.'/'.$lockFile;
            if (is_file($lockPath) && filemtime($lockPath) >= $packageTime) {
                return true;
            }
        }
        
        return false;
    }

    private function detectPackageManager(): string
    {
        if (is_file($this->serverDir.'/pnpm-lock.yaml')) {
            return 'pnpm';
        }

        if (is_file($this->serverDir.'/yarn.lock')) {
            return 'yarn';
        }

        $pnpmProcess = new Process(['pnpm', '--version']);
        $pnpmProcess->run();

        if ($pnpmProcess->isSuccessful()) {
            return 'pnpm';
        }

        $yarnProcess = new Process(['yarn', '--version']);
        $yarnProcess->run();

        if ($yarnProcess->isSuccessful()) {
            return 'yarn';
        }

        return 'npm';
    }

    private function getInstallCommand(string $packageManager): array
    {
        $hasPnpmLock = is_file($this->serverDir.'/pnpm-lock.yaml');
        $hasYarnLock = is_file($this->serverDir.'/yarn.lock');
        $hasNpmLock = is_file($this->serverDir.'/package-lock.json');

        return match ($packageManager) {
            'pnpm' => $hasPnpmLock
                    ? ['pnpm', 'install', '--prod', '--frozen-lockfile']
                    : ['pnpm', 'install', '--prod', '--no-frozen-lockfile'],
            'yarn' => $hasYarnLock
                    ? ['yarn', 'install', '--production', '--frozen-lockfile']
                    : ['yarn', 'install', '--production'],
            default => $hasNpmLock
                    ? ['npm', 'ci', '--only=production']
                    : ['npm', 'install', '--only=production']
        };
    }

    private function verifyInstallation(): void
    {
        $this->output->writeln('Verifying installation...', OutputInterface::VERBOSITY_VERBOSE);

        $resolve = new Process(['node', '-p', "require.resolve('playwright')"], $this->serverDir);
        $resolve->setTimeout(30);
        $resolve->run();

        if (!$resolve->isSuccessful()) {
            throw new \RuntimeException('Server verification failed - playwright package not resolvable');
        }

        if (!is_file($this->serverDir.'/playwright-server.js')) {
            throw new \RuntimeException('Server entry script not found: playwright-server.js');
        }

        $this->output->writeln('✓ Server verified');
    }
}

$help = \in_array('-h', $_SERVER['argv'] ?? [], true)
        || \in_array('--help', $_SERVER['argv'] ?? [], true);

if ($help) {
    echo "Playwright Server Installer\n";
    echo "\n";
    echo "Usage: bin/playwright-install [options]\n";
    echo "\n";
    echo "Options:\n";
    echo "  -v, --verbose    Show detailed output\n";
    echo "  -h, --help       Show this help message\n";
    echo "\n";
    echo "Requirements:\n";
    echo "  - Node.js 20+ (for optimal performance and security)\n";
    echo "  - npm, yarn, or pnpm\n";
    echo "\n";
    echo "This script automatically detects and uses the fastest available package manager.\n";
    echo "Preference order: pnpm > yarn > npm\n";
    exit(0);
}

$installer = new PlaywrightServerInstaller();
exit($installer->install());
